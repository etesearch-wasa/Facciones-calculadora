<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Facciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        input[type="number"] { width: 100%; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-gray-800 border-b border-gray-700 p-4 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-fort-awesome text-yellow-500 text-2xl"></i>
                <h1 class="text-xl font-bold tracking-wide">Gestor de Facción</h1>
            </div>
            <div class="flex gap-2 text-sm">
                <button onclick="switchTab('general')" class="tab-btn px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 transition font-semibold" id="btn-general">General</button>
                <button onclick="switchTab('edificios')" class="tab-btn px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition" id="btn-edificios">Edificios</button>
                <button onclick="switchTab('produccion')" class="tab-btn px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition" id="btn-produccion">Producción</button>
                <button onclick="switchTab('combate')" class="tab-btn px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition" id="btn-combate">Combate</button>
                <button onclick="switchTab('botdata')" class="tab-btn px-4 py-2 rounded-lg bg-purple-700 hover:bg-purple-600 transition font-mono" id="btn-botdata"><i class="fa-solid fa-robot mr-2"></i>Bot Data</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto p-6 flex-grow">

        <!-- TAB 1: GENERAL -->
        <div id="general" class="tab-content active space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Identificación -->
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-sm">
                    <h2 class="text-lg font-bold text-yellow-400 mb-4 border-b border-gray-700 pb-2"><i class="fa-solid fa-id-card mr-2"></i>Datos de Facción</h2>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-xs text-gray-400 uppercase font-bold mb-1">Nombre de la Facción</label>
                            <input type="text" id="factionName" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ej. Los Supervivientes" oninput="updateAll()">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-gray-400 uppercase font-bold mb-1">ID Usuario Discord</label>
                                <input type="text" id="discordId" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="123456789" oninput="updateAll()">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 uppercase font-bold mb-1">Usuario (Original)</label>
                                <input type="text" id="discordUser" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="usuario_original" oninput="updateAll()">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 uppercase font-bold mb-1">Nivel de Facción</label>
                            <input type="number" id="factionLevel" value="1" min="1" max="5" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:ring-2 focus:ring-blue-500 outline-none" oninput="updateAll()">
                        </div>
                    </div>
                </div>

                <!-- Censo -->
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-sm">
                    <h2 class="text-lg font-bold text-green-400 mb-4 border-b border-gray-700 pb-2"><i class="fa-solid fa-users mr-2"></i>Censo Poblacional</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-gray-400 uppercase font-bold mb-1">Adultos (Trabajo Pesado)</label>
                            <input type="number" id="popAdultHeavy" value="0" class="bg-gray-700 border border-gray-600 rounded p-2 w-full text-white" oninput="updateAll()">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 uppercase font-bold mb-1">Adultos (Trabajo Normal)</label>
                            <input type="number" id="popAdultNormal" value="0" class="bg-gray-700 border border-gray-600 rounded p-2 w-full text-white" oninput="updateAll()">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 uppercase font-bold mb-1">Adultos (Trabajo Ligero)</label>
                            <input type="number" id="popAdultLight" value="0" class="bg-gray-700 border border-gray-600 rounded p-2 w-full text-white" oninput="updateAll()">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 uppercase font-bold mb-1">Niños</label>
                            <input type="number" id="popKids" value="0" class="bg-gray-700 border border-gray-600 rounded p-2 w-full text-white" oninput="updateAll()">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 uppercase font-bold mb-1">Ancianos</label>
                            <input type="number" id="popElders" value="0" class="bg-gray-700 border border-gray-600 rounded p-2 w-full text-white" oninput="updateAll()">
                        </div>
                        <div class="bg-gray-700 rounded p-2 flex flex-col justify-center items-center">
                            <span class="text-xs text-gray-400">Total Población</span>
                            <span id="totalPopDisplay" class="text-2xl font-bold text-white">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Resumen -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-gray-800 p-4 rounded-lg border-l-4 border-yellow-500 shadow">
                    <div class="text-gray-400 text-sm">Energía (Gen/Cons)</div>
                    <div class="text-xl font-bold flex items-center gap-2">
                        <span id="dashEnergyGen" class="text-green-400">0</span> / <span id="dashEnergyCons" class="text-red-400">0</span>
                    </div>
                    <div id="dashEnergyStatus" class="text-xs mt-1 text-gray-500">Estable</div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg border-l-4 border-green-500 shadow">
                    <div class="text-gray-400 text-sm">Comida (Prod/Cons)</div>
                    <div class="text-xl font-bold flex items-center gap-2">
                        <span id="dashFoodProd" class="text-green-400">0</span> / <span id="dashFoodCons" class="text-red-400">0</span>
                    </div>
                    <div id="dashFoodStatus" class="text-xs mt-1 text-gray-500">Equilibrio</div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg border-l-4 border-blue-500 shadow">
                    <div class="text-gray-400 text-sm">Defensa Sector</div>
                    <div class="text-2xl font-bold text-white" id="dashDefense">0%</div>
                    <div class="text-xs mt-1 text-gray-500">Buff Total</div>
                </div>
                 <div class="bg-gray-800 p-4 rounded-lg border-l-4 border-purple-500 shadow">
                    <div class="text-gray-400 text-sm">Expansión Máx.</div>
                    <div class="text-xl font-bold text-white"><span id="dashExpansion">0</span> casillas</div>
                    <div class="text-xs mt-1 text-gray-500">Basado en Nivel y Centros</div>
                </div>
            </div>
        </div>

        <!-- TAB 2: EDIFICIOS -->
        <div id="edificios" class="tab-content space-y-6">
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-blue-400"><i class="fa-solid fa-city mr-2"></i>Matriz de Edificios</h2>
                    <div class="text-xs text-gray-400 bg-gray-700 px-3 py-1 rounded">Introduce la cantidad de edificios que tienes de cada nivel</div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                            <tr>
                                <th class="px-4 py-3 rounded-tl-lg">Tipo de Edificio</th>
                                <th class="px-2 py-3 text-center">Nivel 1</th>
                                <th class="px-2 py-3 text-center">Nivel 2</th>
                                <th class="px-2 py-3 text-center">Nivel 3</th>
                                <th class="px-2 py-3 text-center">Nivel 4</th>
                                <th class="px-2 py-3 text-center rounded-tr-lg">Nivel 5</th>
                            </tr>
                        </thead>
                        <tbody id="buildingsTableBody" class="divide-y divide-gray-700">
                            <!-- Rows generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Generación de Energía -->
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                    <h3 class="font-bold text-yellow-400 mb-4">Generadores de Energía</h3>
                    <div id="energyGenerators" class="space-y-4">
                        <!-- Inputs generated by JS -->
                    </div>
                </div>
                
                <!-- Buffs Activos -->
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                    <h3 class="font-bold text-purple-400 mb-4">Buffs Activos por Edificios</h3>
                    <ul id="activeBuffsList" class="space-y-2 text-sm text-gray-300">
                        <li>Calculando...</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- TAB 3: PRODUCCIÓN -->
        <div id="produccion" class="tab-content space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Agricultura -->
                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700">
                    <h3 class="font-bold text-green-500 mb-3"><i class="fa-solid fa-wheat-awn mr-2"></i>Agricultura</h3>
                    <div class="space-y-3 text-sm">
                        <div>
                            <label class="block text-gray-400 mb-1">Nivel Huerto/Granja (1-5)</label>
                            <input type="number" id="farmLevel" value="0" min="0" max="5" class="bg-gray-700 p-2 rounded w-full text-white" oninput="updateAll()">
                        </div>
                        <div>
                            <label class="block text-gray-400 mb-1">Tipo de Cultivo</label>
                            <select id="cropType" class="bg-gray-700 p-2 rounded w-full text-white" onchange="updateAll()">
                                <option value="1.0">Granos (x1.0)</option>
                                <option value="0.8">Verduras (x0.8)</option>
                                <option value="1.2">Frutas (x1.2)</option>
                                <option value="1.5">Especiales (x1.5)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-400 mb-1">Eficiencia Agricultor</label>
                            <select id="farmerEff" class="bg-gray-700 p-2 rounded w-full text-white" onchange="updateAll()">
                                <option value="1.0">Común (x1.0)</option>
                                <option value="1.2">Aprendiz (x1.2)</option>
                                <option value="1.5">Especialista (x1.5)</option>
                                <option value="1.7">Experto (x1.7)</option>
                                <option value="2.0">Maestro (x2.0)</option>
                            </select>
                        </div>
                        <div class="pt-2 border-t border-gray-600">
                            <p class="flex justify-between font-bold"><span>Producción:</span> <span id="agriOutput" class="text-green-400">0 rac/día</span></p>
                        </div>
                    </div>
                </div>

                <!-- Ganadería -->
                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700">
                    <h3 class="font-bold text-red-400 mb-3"><i class="fa-solid fa-cow mr-2"></i>Ganadería</h3>
                    <div class="space-y-3 text-sm">
                         <div class="grid grid-cols-2 gap-2">
                             <div><label class="text-xs">Gallinas</label><input type="number" id="animChicken" value="0" class="bg-gray-700 p-1 rounded w-full" oninput="updateAll()"></div>
                             <div><label class="text-xs">Ovejas</label><input type="number" id="animSheep" value="0" class="bg-gray-700 p-1 rounded w-full" oninput="updateAll()"></div>
                             <div><label class="text-xs">Cerdos</label><input type="number" id="animPig" value="0" class="bg-gray-700 p-1 rounded w-full" oninput="updateAll()"></div>
                             <div><label class="text-xs">Vacas</label><input type="number" id="animCow" value="0" class="bg-gray-700 p-1 rounded w-full" oninput="updateAll()"></div>
                         </div>
                         <div>
                             <label class="block text-gray-400 mb-1">% Nutrición Animal</label>
                             <input type="range" id="animNutrition" min="0" max="100" value="100" class="w-full" oninput="document.getElementById('nutriVal').innerText = this.value + '%'; updateAll()">
                             <span id="nutriVal" class="text-xs text-right block text-gray-400">100%</span>
                         </div>
                         <div>
                            <label class="block text-gray-400 mb-1">Eficiencia Ganadero</label>
                            <select id="rancherEff" class="bg-gray-700 p-2 rounded w-full text-white" onchange="updateAll()">
                                <option value="1.0">Común</option>
                                <option value="1.2">Aprendiz</option>
                                <option value="1.5">Especialista</option>
                                <option value="1.7">Experto</option>
                                <option value="2.0">Maestro</option>
                            </select>
                        </div>
                        <div class="pt-2 border-t border-gray-600">
                            <p class="flex justify-between font-bold"><span>Prod. Carne:</span> <span id="ranchMeatOutput" class="text-red-400">0 rac/día</span></p>
                            <p class="flex justify-between text-xs text-gray-400"><span>Consumo Animal:</span> <span id="animConsumption">0 rac</span></p>
                        </div>
                    </div>
                </div>

                <!-- Recolección -->
                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700">
                    <h3 class="font-bold text-blue-400 mb-3"><i class="fa-solid fa-hammer mr-2"></i>Recolección Manual</h3>
                    <div class="space-y-3 text-sm">
                        <p class="text-xs text-gray-400">Calculado automáticamente según los niveles de tus 'Zonas de Recolección' en la pestaña Edificios.</p>
                        <ul id="gatheringDetails" class="space-y-1 text-gray-300">
                            <!-- Filled by JS -->
                        </ul>
                        <div class="pt-2 border-t border-gray-600">
                            <p class="flex justify-between font-bold"><span>Total Materiales:</span> <span id="gatheringOutput" class="text-blue-400">0 u/día</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 4: COMBATE -->
        <div id="combate" class="tab-content space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Atacante -->
                <div class="bg-red-900/20 p-6 rounded-xl border border-red-800">
                    <h3 class="text-xl font-bold text-red-500 mb-4">Fuerzas Atacantes</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-300">Cantidad Soldados</label>
                            <input type="number" id="attSoldiers" value="10" class="bg-gray-800 border border-red-700 rounded p-2 w-full" oninput="calcCombat()">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-300">Nivel Exp. (0.8 - 2.0)</label>
                                <input type="number" step="0.1" id="attExp" value="1.0" class="bg-gray-800 border border-red-700 rounded p-2 w-full" oninput="calcCombat()">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-300">Moral (0.5 - 1.5)</label>
                                <input type="number" step="0.1" id="attMoral" value="1.0" class="bg-gray-800 border border-red-700 rounded p-2 w-full" oninput="calcCombat()">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300">Equipamiento (Armas/Soldado)</label>
                            <select id="attEquip" class="bg-gray-800 border border-red-700 rounded p-2 w-full" onchange="calcCombat()">
                                <option value="0.75">Escasez crítica (< 0.5)</option>
                                <option value="0.9">Escasez (0.5-0.8)</option>
                                <option value="1.0" selected>Equilibrio (0.9-1.1)</option>
                                <option value="1.15">Buena dotación (1.2-1.5)</option>
                                <option value="1.25">Sobredotación (> 1.5)</option>
                            </select>
                        </div>
                        <div class="pt-4 border-t border-blue-800 mt-2">
                            <p class="text-2xl font-bold text-blue-400 text-center" id="defPowerDisplay">Poder: 0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resultado -->
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-600 text-center mt-6 shadow-lg">
                <h3 class="text-lg font-bold text-white mb-2 uppercase tracking-widest">Predicción de Resultado</h3>
                <div id="combatResultText" class="text-3xl font-extrabold text-yellow-500 mb-2 animate-pulse">Empate</div>
                <div class="text-sm text-gray-400 font-mono" id="combatDetails">Diferencia: 0</div>
                <div class="grid grid-cols-2 gap-4 mt-6 text-sm border-t border-gray-700 pt-4">
                    <div class="text-red-400 font-bold">Bajas Atacante Est.: <span id="attCasualties" class="text-white text-lg ml-1">0</span></div>
                    <div class="text-blue-400 font-bold">Bajas Defensor Est.: <span id="defCasualties" class="text-white text-lg ml-1">0</span></div>
                </div>
            </div>
        </div>

        <!-- TAB 5: BOT DATA -->
        <div id="botdata" class="tab-content">
            <div class="bg-gray-800 p-6 rounded-xl border border-purple-700 shadow-lg">
                <div class="flex justify-between items-center mb-4 border-b border-purple-900 pb-2">
                    <h2 class="text-lg font-bold text-purple-400">JSON para Bot Discord</h2>
                    <button onclick="copyBotData()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded text-sm font-bold transition flex items-center shadow-lg transform hover:-translate-y-1">
                        <i class="fa-solid fa-copy mr-2"></i> Copiar
                    </button>
                </div>
                <p class="text-sm text-gray-400 mb-4">Este código contiene toda la información actual de tu facción. El bot leerá el "discordId" para vincular los datos.</p>
                <textarea id="jsonOutput" class="w-full h-80 bg-gray-900 border border-gray-700 rounded-lg p-4 text-green-400 font-mono text-xs outline-none focus:border-purple-500 transition" readonly></textarea>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 border-t border-gray-700 p-4 text-center text-xs text-gray-500 mt-auto">
        Sistema de Gestión de Facciones v1.2
    </footer>

    <!-- LOGICA JAVASCRIPT -->
    <script>
        // CONFIGURACIÓN DE EDIFICIOS (Tipos y Consumos)
        const buildingTypes = [
            "Murallas", "Torres Vigilancia", "Zonas Recolección", 
            "Viviendas", "Huertos/Granjas", "Corrales/Ranchos", 
            "Aserraderos/Manufactura", "Taller Herramientas", 
            "Hospitales/Clínicas", "Energía Eólica", "Energía Solar",
            "Expansión Base", "Célula Comando", "Puesto Comando", "Centro Comando"
        ];
        
        // Consumo de energía por nivel (según PDF)
        const energyConsPerLevel = [0, 2, 5, 10, 20, 50]; 
        
        // Buffs de Vivienda (Reducción consumo comida) - No acumulable, se toma el máximo
        const housingBuffs = [0, 0.10, 0.15, 0.20, 0.25, 0.30];

        // Buffs de Defensa (Murallas)
        const wallDefenseBuffs = [0, 0.10, 0.25, 0.40, 0.60, 0.80];

        // Producción base Recolección por nivel
        const gatheringProd = [0, 5, 10, 15, 20, 30];

        // INICIALIZACIÓN
        document.addEventListener('DOMContentLoaded', () => {
            generateBuildingTable();
            updateAll();
        });

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.replace('bg-blue-600', 'bg-gray-700'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.replace('bg-purple-700', 'bg-gray-700'));
            
            document.getElementById(tabId).classList.add('active');
            const btn = document.getElementById('btn-' + tabId);
            if(btn) {
                btn.classList.remove('bg-gray-700');
                btn.classList.add(tabId === 'botdata' ? 'bg-purple-700' : 'bg-blue-600');
            }
        }

        function generateBuildingTable() {
            const tbody = document.getElementById('buildingsTableBody');
            buildingTypes.forEach((type, index) => {
                const tr = document.createElement('tr');
                tr.className = "bg-gray-800 border-b border-gray-700 hover:bg-gray-750 transition";
                
                let cells = `<th scope="row" class="px-4 py-3 font-medium text-white whitespace-nowrap text-xs md:text-sm">${type}</th>`;
                
                for(let lvl=1; lvl<=5; lvl++) {
                    cells += `
                        <td class="px-1 py-2">
                            <input type="number" min="0" value="0" 
                                data-type="${type}" data-level="${lvl}" 
                                class="bg-gray-700 border border-gray-600 text-white text-center text-xs rounded focus:ring-blue-500 focus:border-blue-500 block w-full p-1 building-input" 
                                oninput="updateAll()">
                        </td>
                    `;
                }
                tr.innerHTML = cells;
                tbody.appendChild(tr);
            });

            // Generar inputs extra para Energía
            const energyDiv = document.getElementById('energyGenerators');
            energyDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><label class="block text-gray-400 text-xs uppercase font-bold">Molinos Nivel 1</label><input type="number" id="wind1" value="0" class="bg-gray-700 rounded p-2 w-full text-white mt-1" oninput="updateAll()"></div>
                    <div><label class="block text-gray-400 text-xs uppercase font-bold">Molinos Nivel 2</label><input type="number" id="wind2" value="0" class="bg-gray-700 rounded p-2 w-full text-white mt-1" oninput="updateAll()"></div>
                    <div><label class="block text-gray-400 text-xs uppercase font-bold">Molinos Nivel 3</label><input type="number" id="wind3" value="0" class="bg-gray-700 rounded p-2 w-full text-white mt-1" oninput="updateAll()"></div>
                    <div><label class="block text-gray-400 text-xs uppercase font-bold">Paneles Solares N2</label><input type="number" id="solar2" value="0" class="bg-gray-700 rounded p-2 w-full text-white mt-1" oninput="updateAll()"></div>
                    <div><label class="block text-gray-400 text-xs uppercase font-bold">Paneles Solares N3</label><input type="number" id="solar3" value="0" class="bg-gray-700 rounded p-2 w-full text-white mt-1" oninput="updateAll()"></div>
                    <div><label class="block text-gray-400 text-xs uppercase font-bold">Paneles Solares N4</label><input type="number" id="solar4" value="0" class="bg-gray-700 rounded p-2 w-full text-white mt-1" oninput="updateAll()"></div>
                    <div><label class="block text-gray-400 text-xs uppercase font-bold">Paneles Solares N5</label><input type="number" id="solar5" value="0" class="bg-gray-700 rounded p-2 w-full text-white mt-1" oninput="updateAll()"></div>
                </div>
            `;
        }

        function updateAll() {
            // 1. Calcular Población
            const adultsH = parseInt(document.getElementById('popAdultHeavy').value) || 0;
            const adultsN = parseInt(document.getElementById('popAdultNormal').value) || 0;
            const adultsL = parseInt(document.getElementById('popAdultLight').value) || 0;
            const kids = parseInt(document.getElementById('popKids').value) || 0;
            const elders = parseInt(document.getElementById('popElders').value) || 0;
            
            const totalPop = adultsH + adultsN + adultsL + kids + elders;
            document.getElementById('totalPopDisplay').innerText = totalPop;

            // 2. Procesar Edificios (Energía y Buffs)
            let totalEnergyCons = 0;
            let maxHousingLevel = 0;
            let totalWallBuff = 0;
            let totalGatheringProd = 0;
            let activeBuffs = [];
            let expansionSlots = 0;

            document.querySelectorAll('.building-input').forEach(input => {
                const count = parseInt(input.value) || 0;
                if(count > 0) {
                    const type = input.dataset.type;
                    const lvl = parseInt(input.dataset.level);
                    
                    // Consumo de energía
                    totalEnergyCons += count * energyConsPerLevel[lvl];

                    // Buff Vivienda
                    if(type === "Viviendas" && lvl > maxHousingLevel) maxHousingLevel = lvl;

                    // Buff Murallas
                    if(type === "Murallas") totalWallBuff += wallDefenseBuffs[lvl] * count; 

                    // Producción Recolección
                    if(type === "Zonas Recolección") {
                        totalGatheringProd += count * gatheringProd[lvl];
                        activeBuffs.push(`${count}x Zona Recolección N${lvl}: +${count * gatheringProd[lvl]} mats/día`);
                    }

                    // Expansión
                    if(type.includes("Expansión")) expansionSlots += count; 
                }
            });

            // 3. Generación de Energía (Aprox basada en PDF)
            const w1 = (parseInt(document.getElementById('wind1').value) || 0) * 15;
            const w2 = (parseInt(document.getElementById('wind2').value) || 0) * 25;
            const w3 = (parseInt(document.getElementById('wind3').value) || 0) * 50;
            
            const s2 = (parseInt(document.getElementById('solar2').value) || 0) * 50; 
            const s3 = (parseInt(document.getElementById('solar3').value) || 0) * 150;
            const s4 = (parseInt(document.getElementById('solar4').value) || 0) * 300;
            const s5 = (parseInt(document.getElementById('solar5').value) || 0) * 500;

            const totalEnergyGen = w1 + w2 + w3 + s2 + s3 + s4 + s5;

            // 4. Consumo Comida
            let rawFoodCons = (adultsH * 1.5) + (adultsN * 1.2) + (adultsL * 1.0) + (kids * 0.5) + (elders * 0.7);
            
            // Aplicar Buff Vivienda
            const houseBuff = housingBuffs[maxHousingLevel];
            const foodConsAfterHouse = rawFoodCons * (1 - houseBuff);
            if(houseBuff > 0) activeBuffs.push(`Vivienda N${maxHousingLevel}: -${(houseBuff*100).toFixed(0)}% consumo raciones`);

            // Consumo Animales
            const chick = parseInt(document.getElementById('animChicken').value) || 0;
            const sheep = parseInt(document.getElementById('animSheep').value) || 0;
            const pig = parseInt(document.getElementById('animPig').value) || 0;
            const cow = parseInt(document.getElementById('animCow').value) || 0;
            
            const animCons = (chick * 0.2) + (sheep * 3.0) + (pig * 5.0) + (cow * 10.0);
            const totalFoodCons = foodConsAfterHouse + animCons;

            // 5. Producción Comida
            // Agri
            const farmLvl = parseInt(document.getElementById('farmLevel').value) || 0;
            const cropMod = parseFloat(document.getElementById('cropType').value);
            const farmerEff = parseFloat(document.getElementById('farmerEff').value);
            const farmBases = [0, 5, 15, 30, 60, 120];
            const agriProd = farmBases[farmLvl] * cropMod * farmerEff;

            // Ranch
            const ranchEff = parseFloat(document.getElementById('rancherEff').value);
            const nutri = parseInt(document.getElementById('animNutrition').value) / 100;
            const meatProd = ((chick * 0.5) + (pig * 2.0) + (sheep * 3.0) + (cow * 5.0)) * nutri * ranchEff;

            const totalFoodProd = agriProd + meatProd;

            // 6. Actualizar UI
            document.getElementById('dashEnergyGen').innerText = totalEnergyGen;
            document.getElementById('dashEnergyCons').innerText = totalEnergyCons;
            document.getElementById('dashEnergyStatus').innerText = totalEnergyGen >= totalEnergyCons ? "Estable" : "Apagón/Déficit";
            document.getElementById('dashEnergyStatus').className = totalEnergyGen >= totalEnergyCons ? "text-xs mt-1 text-green-500 font-bold" : "text-xs mt-1 text-red-500 font-bold animate-pulse";

            document.getElementById('dashFoodProd').innerText = totalFoodProd.toFixed(1);
            document.getElementById('dashFoodCons').innerText = totalFoodCons.toFixed(1);
            document.getElementById('agriOutput').innerText = agriProd.toFixed(1) + " rac/día";
            document.getElementById('ranchMeatOutput').innerText = meatProd.toFixed(1) + " rac/día";
            document.getElementById('animConsumption').innerText = animCons.toFixed(1) + " rac";
            
            // Recolección
            document.getElementById('gatheringOutput').innerText = totalGatheringProd + " u/día";
            document.getElementById('gatheringDetails').innerHTML = activeBuffs.length > 0 ? activeBuffs.map(b => `<li class="border-b border-gray-700 py-1">${b}</li>`).join('') : '<li class="text-gray-500 italic">No hay buffs activos</li>';

            // Defensa
            document.getElementById('dashDefense').innerText = "+" + (totalWallBuff * 100).toFixed(0) + "%";
            const defInput = document.getElementById('defStructBuff');
            if(defInput.value == 0) defInput.placeholder = (totalWallBuff * 100).toFixed(0);

            // Expansión
            const baseLevel = parseInt(document.getElementById('factionLevel').value) || 1;
            const maxExp = (baseLevel * 2) + expansionSlots; 
            document.getElementById('dashExpansion').innerText = maxExp;

            updateBotJSON();
            calcCombat();
        }

        function calcCombat() {
            // Atacante
            const attSold = parseInt(document.getElementById('attSoldiers').value) || 0;
            const attXP = parseFloat(document.getElementById('attExp').value) || 1;
            const attMoral = parseFloat(document.getElementById('attMoral').value) || 1;
            const attEquip = parseFloat(document.getElementById('attEquip').value) || 1;

            const attPower = (attSold * attXP) * attEquip * attMoral;
            
            // Defensor
            const defSold = parseInt(document.getElementById('defSoldiers').value) || 0;
            const defXP = parseFloat(document.getElementById('defExp').value) || 1;
            const defEquip = parseFloat(document.getElementById('defEquip').value) || 1;
            const defStructVal = parseFloat(document.getElementById('defStructBuff').value) || 0;
            const defStructMod = 1 + (defStructVal / 100);

            const defPower = (defSold * defXP) * defEquip * defStructMod;

            // UI Poder
            document.getElementById('attPowerDisplay').innerText = "Poder: " + attPower.toFixed(1);
            document.getElementById('defPowerDisplay').innerText = "Poder: " + defPower.toFixed(1);

            // Resultado
            const diff = attPower - defPower;
            let resultVal = 0;
            if(defPower > 0) resultVal = diff / (defPower * 2);

            const resText = document.getElementById('combatResultText');
            if(resultVal > 0.5) { resText.innerText = "Victoria Atacante"; resText.className = "text-3xl font-extrabold text-red-500 mb-2"; }
            else if(resultVal >= 0.1) { resText.innerText = "Victoria Aplastante (Atacante)"; resText.className = "text-3xl font-extrabold text-red-600 mb-2"; }
            else if(resultVal >= -0.1) { resText.innerText = "Empate / Retirada"; resText.className = "text-3xl font-extrabold text-yellow-500 mb-2"; }
            else if(resultVal >= -0.5) { resText.innerText = "Victoria Aplastante (Defensor)"; resText.className = "text-3xl font-extrabold text-blue-600 mb-2"; }
            else { resText.innerText = "Victoria Defensor"; resText.className = "text-3xl font-extrabold text-blue-500 mb-2"; }

            document.getElementById('combatDetails').innerText = `Coeficiente: ${resultVal.toFixed(3)} | Diferencia: ${diff.toFixed(1)}`;

            // Bajas (Estimación simple)
            const attCas = attSold > 0 ? Math.floor(attSold * (defPower/(attPower+defPower+1)) * 0.5) : 0;
            const defCas = defSold > 0 ? Math.floor(defSold * (attPower/(attPower+defPower+1)) * (1-(defStructVal/200))) : 0;
            
            document.getElementById('attCasualties').innerText = attCas;
            document.getElementById('defCasualties').innerText = defCas;
        }

        function updateBotJSON() {
            const data = {
                id: document.getElementById('discordId').value,
                user: document.getElementById('discordUser').value,
                faction: {
                    name: document.getElementById('factionName').value,
                    level: parseInt(document.getElementById('factionLevel').value),
                    population: parseInt(document.getElementById('totalPopDisplay').innerText),
                    stats: {
                        energy_gen: parseFloat(document.getElementById('dashEnergyGen').innerText),
                        energy_cons: parseFloat(document.getElementById('dashEnergyCons').innerText),
                        food_prod: parseFloat(document.getElementById('dashFoodProd').innerText),
                        food_cons: parseFloat(document.getElementById('dashFoodCons').innerText),
                        defense_bonus: parseFloat(document.getElementById('dashDefense').innerText.replace('%',''))
                    },
                    buildings: {}, 
                    last_update: new Date().toISOString()
                }
            };
            
            // Llenar edificios compactos
            document.querySelectorAll('.building-input').forEach(input => {
                if(parseInt(input.value) > 0) {
                    const key = `${input.dataset.type}_L${input.dataset.level}`;
                    data.faction.buildings[key] = parseInt(input.value);
                }
            });

            document.getElementById('jsonOutput').value = JSON.stringify(data, null, 2);
        }

        function copyBotData() {
            const copyText = document.getElementById("jsonOutput");
            copyText.select();
            document.execCommand("copy");
            // Usar API moderna si está disponible para evitar errores en móviles
            if (navigator.clipboard) {
                navigator.clipboard.writeText(copyText.value).then(() => {
                    alert("JSON copiado al portapapeles.");
                });
            } else {
                alert("JSON copiado (método antiguo).");
            }
        }
    </script>
</body>
</html>